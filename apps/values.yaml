repoURL: https://github.com/Yornik/sharkshere-gitops.git
targetRevision: main

# Define your apps here. Each entry becomes an ArgoCD Application.
#
# To add a new app:
#   1. Add an entry below
#   2. Create its manifests under manifests/<name>/
#   3. Push â€” ArgoCD picks it up automatically
#
apps:
  local-path-provisioner:
    namespace: local-path-storage
    path: manifests/local-path-provisioner

  smb-csi-driver:
    namespace: kube-system
    helm:
      repoURL: https://raw.githubusercontent.com/kubernetes-csi/csi-driver-smb/master/charts
      chart: csi-driver-smb
      targetRevision: "v1.*"
      values: |
        controller:
          replicas: 1

  external-dns:
    namespace: external-dns
    path: manifests/external-dns

  monitoring:
    namespace: monitoring
    path: manifests/monitoring

  kube-prometheus-stack:
    namespace: monitoring
    syncOptions:
      - ServerSideApply=true
    helm:
      repoURL: https://prometheus-community.github.io/helm-charts
      chart: kube-prometheus-stack
      targetRevision: "72.*"
      values: |
        # Talos Linux: control plane components not accessible via Omni
        kubeEtcd:
          enabled: false
        kubeControllerManager:
          enabled: false
        kubeScheduler:
          enabled: false
        kubeProxy:
          enabled: false

        # Grafana
        grafana:
          admin:
            existingSecret: grafana-admin
            userKey: admin-user
            passwordKey: admin-password
          persistence:
            enabled: true
            storageClassName: truenas-nfs
            size: 2Gi
          sidecar:
            dashboards:
              enabled: true
            datasources:
              enabled: true

        # Prometheus
        prometheus:
          prometheusSpec:
            retention: 15d
            storageSpec:
              volumeClaimTemplate:
                spec:
                  storageClassName: truenas-nfs
                  resources:
                    requests:
                      storage: 20Gi

        # Alertmanager
        alertmanager:
          alertmanagerSpec:
            storage:
              volumeClaimTemplate:
                spec:
                  storageClassName: truenas-nfs
                  resources:
                    requests:
                      storage: 2Gi

        # Node exporter - Talos has no systemd
        prometheus-node-exporter:
          extraArgs:
            - --no-collector.systemd

  loki:
    namespace: monitoring
    helm:
      repoURL: https://grafana.github.io/helm-charts
      chart: loki
      targetRevision: "6.*"
      values: |
        deploymentMode: SingleBinary
        loki:
          auth_enabled: false
          commonConfig:
            replication_factor: 1
          limits_config:
            retention_period: 48h
            allow_structured_metadata: false
            ingestion_rate_mb: 100
            ingestion_burst_size_mb: 100
          compactor:
            retention_enabled: true
            delete_request_store: filesystem
            working_directory: /var/loki/compactor
          schemaConfig:
            configs:
              - from: "2024-01-01"
                store: boltdb-shipper
                object_store: filesystem
                schema: v13
                index:
                  prefix: loki_index_
                  period: 24h
          storageConfig:
            boltdb_shipper:
              active_index_directory: /var/loki/index
              cache_location: /var/loki/cache
              shared_store: filesystem
            filesystem:
              directory: /var/loki/chunks
          storage:
            type: filesystem
        singleBinary:
          replicas: 1
          persistence:
            enabled: true
            storageClass: truenas-nfs
            size: 20Gi
        read:
          replicas: 0
        write:
          replicas: 0
        backend:
          replicas: 0
        gateway:
          enabled: false
        lokiCanary:
          enabled: false
        test:
          enabled: false

  promtail:
    namespace: monitoring
    helm:
      repoURL: https://grafana.github.io/helm-charts
      chart: promtail
      targetRevision: "6.*"
      values: |
        config:
          clients:
            - url: http://loki.monitoring.svc:3100/loki/api/v1/push
          snippets:
            pipelineStages:
              - cri: {}
              - match:
                  selector: '{pod=~"loki-canary.*"}'
                  stages:
                    - drop:
                        expression: '(?i)\\bppp{8,}\\b'
              - match:
                  selector: '{app="tibber-exporter"}'
                  stages:
                    - drop:
                        expression: '"liveMeasurement":'
              - json:
                  expressions:
                    level: level
                    severity: severity
                    log_level: log_level
              - regex:
                  expression: '(?i)\\b(?P<level>trace|debug|info|warn|warning|error|fatal|panic)\\b'
              - template:
                  source: level
                  template: '{{ ToLower .Value }}'
              - replace:
                  source: level
                  expression: '^warning$'
                  replace: 'warn'
              - match:
                  selector: '{stream="stderr"}'
                  stages:
                    - template:
                        source: level
                        template: '{{ if .Value }}{{ .Value }}{{ else }}error{{ end }}'
              - match:
                  selector: '{stream="stdout"}'
                  stages:
                    - template:
                        source: level
                        template: '{{ if .Value }}{{ .Value }}{{ else }}info{{ end }}'
              - drop:
                  longer_than: 16kb
              - labels:
                  level:
            extraRelabelConfigs:
              - action: drop
                source_labels:
                  - __meta_kubernetes_namespace
                regex: argocd
              - action: drop
                source_labels:
                  - __meta_kubernetes_pod_name
                regex: loki-canary.*
              - action: drop
                source_labels:
                  - pod
                regex: loki-canary.*
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            cpu: 250m
            memory: 256Mi
        tolerations:
          - operator: Exists

  tibber-exporter:
    namespace: monitoring
    path: manifests/tibber-exporter

  jellyfin:
    namespace: jellyfin
    path: manifests/jellyfin

  qbittorrent:
    namespace: jellyfin
    path: manifests/qbittorrent

  democratic-csi:
    namespace: democratic-csi
    path: manifests/democratic-csi

  democratic-csi-nfs:
    namespace: democratic-csi
    helm:
      repoURL: https://democratic-csi.github.io/charts/
      chart: democratic-csi
      targetRevision: "*"
      values: |
        csiDriver:
          name: org.democratic-csi.nfs
        driver:
          existingConfigSecret: democratic-csi-nfs-driver-config
          config:
            driver: freenas-api-nfs
        storageClasses:
          - name: truenas-nfs
            defaultClass: true
            reclaimPolicy: Delete
            allowVolumeExpansion: true
            parameters:
              fsType: nfs
            mountOptions:
              - noatime
              - nfsvers=4
        volumeSnapshotClasses: []

  democratic-csi-iscsi:
    namespace: democratic-csi
    helm:
      repoURL: https://democratic-csi.github.io/charts/
      chart: democratic-csi
      targetRevision: "*"
      values: |
        csiDriver:
          name: org.democratic-csi.iscsi
        node:
          hostPID: true
          driver:
            extraEnv:
              - name: ISCSIADM_HOST_STRATEGY
                value: nsenter
              - name: ISCSIADM_HOST_PATH
                value: /usr/local/sbin/iscsiadm
            iscsiDirHostPath: /etc/iscsi
            iscsiDirHostPathType: ""
        driver:
          existingConfigSecret: democratic-csi-iscsi-driver-config
          config:
            driver: freenas-api-iscsi
        storageClasses:
          - name: truenas-iscsi
            defaultClass: false
            reclaimPolicy: Delete
            allowVolumeExpansion: true
            parameters:
              fsType: ext4
            mountOptions: []
        volumeSnapshotClasses: []

  traefik:
    namespace: traefik
    helm:
      repoURL: https://traefik.github.io/charts
      chart: traefik
      targetRevision: "39.*"
      values: |
        service:
          type: ClusterIP
          annotations:
            tailscale.com/expose: "true"
            tailscale.com/hostname: traefik
        ports:
          web:
            port: 8000
            exposedPort: 80
            protocol: TCP
            proxyProtocol:
              trustedIPs:
                - "10.0.0.0/8"
                - "100.64.0.0/10"
            forwardedHeaders:
              trustedIPs:
                - "10.0.0.0/8"
                - "100.64.0.0/10"
            http:
              redirections:
                entryPoint:
                  to: websecure
                  scheme: https
          websecure:
            port: 8443
            exposedPort: 443
            protocol: TCP
            proxyProtocol:
              trustedIPs:
                - "10.0.0.0/8"
                - "100.64.0.0/10"
            forwardedHeaders:
              trustedIPs:
                - "10.0.0.0/8"
                - "100.64.0.0/10"
            http:
              tls:
                options: hardened@file
        certificatesResolvers:
          letsencrypt:
            acme:
              email: yornik@yornik.nl
              storage: /data/acme.json
              httpChallenge:
                entryPoint: web
        persistence:
          enabled: true
          storageClass: truenas-nfs
          size: 128Mi
        providers:
          kubernetesCRD:
            enabled: true
            allowCrossNamespace: true
          kubernetesIngress:
            enabled: true
          file:
            enabled: true
            content: |
              tls:
                options:
                  hardened:
                    minVersion: VersionTLS12
                    cipherSuites:
                      - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
                      - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
                      - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
                      - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
                      - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305
                      - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305
                    sniStrict: true
        experimental:
          plugins:
            fail2ban:
              moduleName: github.com/tomMoulard/fail2ban
              version: v0.8.9
        ingressClass:
          enabled: true
          isDefaultClass: true

  traefik-config:
    namespace: traefik
    path: manifests/traefik-config

  tailscale:
    namespace: tailscale
    path: manifests/tailscale

  tailscale-operator:
    namespace: tailscale
    helm:
      repoURL: https://pkgs.tailscale.com/helmcharts
      chart: tailscale-operator
      targetRevision: "*"
      values: |
        oauth:
          clientId: ""
          clientSecret: ""
        operatorConfig:
          defaultTags:
            - "tag:k8s-operator"
        proxyConfig:
          defaultTags: "tag:k8s"
        apiServerProxyConfig:
          mode: "false"
